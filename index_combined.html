
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NAICS (2022) — Search (SOT) with Legacy Guidance</title>
  <meta name="description" content="Exact 6-digit inputs return NAICS (2022) records only. Legacy codes are blocked with a guidance banner and recommended 2022 codes." />
  <style>
    /* Base UI */
    :root {
      --text: #111;
      --muted: #555;
      --card-border: #e9e9e9;
      --accent: #1a73e8;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); margin: 24px; }
    h1 { font-size: 1.35rem; margin: 0 0 6px; }
    .subtitle { color: var(--muted); margin: 0 0 12px; }
    .row { margin: 12px 0; display: flex; gap: 8px; align-items: center; }
    input[type="text"]{ padding: 8px 10px; font-size: 1rem; width: 360px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
    button:hover { border-color: var(--accent); }
    .results { margin-top: 16px; }
    .card { border: 1px solid var(--card-border); border-radius: 8px; padding: 12px; margin-bottom: 10px; background: #fff; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color: #222; }
    .links a { color: var(--accent); text-decoration: none; }
    .links a:hover { text-decoration: underline; }

    /* Legacy banner */
    .legacy-banner {
      display: none;
      border: 1px solid #d93025;
      background: #fdecea;
      color: #4a1f1f;
      padding: 12px 16px;
      border-radius: 6px;
      margin: 12px 0;
    }
    .legacy-banner .title { font-weight: 600; margin-bottom: 4px; }
    .legacy-banner code { background: #fff; border: 1px solid #e0e0e0; padding: 2px 6px; border-radius: 4px; }
    .legacy-banner .note { margin-top: 4px; font-size: 0.95rem; }
    .legacy-banner .links { margin-top: 8px; font-size: 0.9rem; }
    .chip {
      display: inline-flex; align-items: center;
      padding: 4px 8px; margin: 4px 4px 0 0; border: 1px solid #ccc; border-radius: 999px; cursor: pointer; background: #fff;
    }
    .chip:hover { border-color: var(--accent); }
  </style>
</head>
<body>
  <!-- Optional: link back to the classic page -->
  <p style="margin:0 0 12px;">
    index.htmlGo to classic NAICS 2022 page</a>
  </p>

  <h1>NAICS 2022 — Single Source of Truth</h1>
  <p class="subtitle">Exact 6-digit codes return 2022 records only. Legacy (non‑2022) codes are blocked with guidance.</p>

  <div class="row" role="search">
    <input id="searchInput" type="text" placeholder="Search by code (6 digits) or keywords…" aria-label="Search NAICS" />
    <button id="btnSearch" onclick="runSearch()">Search</button>
  </div>

  <!-- Legacy guidance banner -->
  <div id="legacyBanner" class="legacy-banner" role="alert" aria-live="polite">
    <div class="title">Legacy code blocked</div>
    <div class="body">
      <div>Input: <code id="legacyInputCode">—</code></div>

      <!-- Single recommendation -->
      <div id="legacyRecommendedWrap" style="margin-top:6px; display:none;">
        Recommended 2022 code: <code id="legacyRecommended">—</code>
        <button id="applyRecommended" style="margin-left:8px;">Use this code</button>
      </div>

      <!-- Multi recommendations (for split cases, optional) -->
      <div id="legacyRecommendedMultiWrap" style="margin-top:6px; display:none;">
        Suggested 2022 codes:
        <span id="legacyMultiContainer"></span>
      </div>

      <div class="note" id="legacyNote"></div>
      <div class="links" id="legacyLinks" style="display:none;">
        <a id="censusLink" target="_blank" rel="noopener">Census 2022</a> ·
        <a id="naicsLink"  target="_blank" rel="noopener">NAICS.com</a>
      </div>
    </div>
  </div>

  <div id="results" class="results"></div>

  <script>
    "use strict";

    const COMBINED_URL = 'naics_2022_combined_with_legacy_guidance.json';

    let indexByCode = {};          // code → 2022 record (Title, Description, etc.)
    let naics2022   = [];          // full 2022 list
    let guidance    = {};          // legacy → {recommended, note} (+ optional recommended_multi)

    function normalizeCode(s) {
      const d = String(s || '').replace(/\D/g, '');
      return d.length >= 6 ? d.slice(0, 6) : d;
    }

    function renderResults(list) {
      const host = document.getElementById('results');
      host.innerHTML = '';
      if (!list || !list.length) {
        host.innerHTML = '<div class="card">No 2022 results to show.</div>';
        return;
      }
      const items = Array.isArray(list) ? list.slice(0, 50) : [list];
      for (const it of items) {
        const code = it.Code || it.code || '';
        const title = it.Title || it.title || '';
        const desc = it.Description || it.description || '';
        const html = `
          <div class="card">
            <div><span class="code">${code}</span> — <strong>${title}</strong></div>
            <div>${desc}</div>
            <div class="links" style="margin-top:8px;">
              ${it['Census_2022_link'] ? `${it[Census 2022</a> · ` : ''}
              ${it['NAICS.com_link']   ? `${it[NAICS.com</a>`   : ''}
            </div>
          </div>`;
        host.insertAdjacentHTML('beforeend', html);
      }
    }

    function keywordSearch(q, list) {
      q = (q || '').trim().toLowerCase();
      if (!q) return [];
      const words = q.split(/\s+/).filter(Boolean);
      const score = (s) => {
        const t = (s || '').toLowerCase();
        return words.reduce((acc, w) => acc + (t.includes(w) ? 1 : 0), 0);
      };
      return list
        .map(r => ({ r, s: score(r.Title) + score(r.Description) }))
        .filter(o => o.s > 0)
        .sort((a, b) => b.s - a.s)
        .map(o => o.r);
    }

    function showLegacyBanner(inputCode, g) {
      const banner   = document.getElementById('legacyBanner');
      const inCodeEl = document.getElementById('legacyInputCode');
      const noteEl   = document.getElementById('legacyNote');
      const linksEl  = document.getElementById('legacyLinks');
      const censusLink = document.getElementById('censusLink');
      const naicsLink  = document.getElementById('naicsLink');

      // Single recommendation elements
      const recWrap  = document.getElementById('legacyRecommendedWrap');
      const recEl    = document.getElementById('legacyRecommended');
      const applyBtn = document.getElementById('applyRecommended');

      // Multi recommendation elements
      const multiWrap = document.getElementById('legacyRecommendedMultiWrap');
      const multiCont = document.getElementById('legacyMultiContainer');

      inCodeEl.textContent = inputCode || '—';
      noteEl.textContent   = (g && g.note) ? g.note : 'This code is not present in NAICS (2022).';

      // Reset
      recWrap.style.display = 'none';
      multiWrap.style.display = 'none';
      linksEl.style.display = 'none';
      multiCont.innerHTML = '';

      // Multi recommendations (optional field)
      const multi = Array.isArray(g?.recommended_multi) ? g.recommended_multi.map(normalizeCode).filter(c => /^\d{6}$/.test(c)) : [];

      if (multi.length) {
        multiWrap.style.display = '';
        multi.forEach(code => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = code;
          chip.title = 'Search this 2022 code';
          chip.onclick = () => applyRecommendedCode(code);
          multiCont.appendChild(chip);
        });
        // Links disabled in multi mode (until user selects a code)
      } else {
        // Single recommendation
        const recommended = normalizeCode(g && g.recommended);
        if (/^\d{6}$/.test(recommended)) {
          recWrap.style.display = '';
          recEl.textContent     = recommended;
          linksEl.style.display = '';
          censusLink.href = `https://www.census.gov/naics/?input=${recommended}&year=2022&details=${recommended}`;
          naicsLink.href  = `https://www.naics.com/naics-code-description/?code=${recommended}&v=2022`;
          applyBtn.onclick = () => applyRecommendedCode(recommended);
        }
      }

      banner.style.display = '';
    }

    function applyRecommendedCode(recommended) {
      const searchBox = document.getElementById('searchInput');
      if (searchBox) {
        searchBox.value = recommended;
        hideLegacyBanner();
        runSearch();
      }
    }

    function hideLegacyBanner() {
      const banner = document.getElementById('legacyBanner');
      if (banner) banner.style.display = 'none';
    }

    async function loadCombined() {
      const combined = await fetch(COMBINED_URL).then(r => r.json());
      guidance = combined.guidance_legacy || {};

      // Use embedded 2022 if present; otherwise fall back to URL pointer
      let data = Array.isArray(combined.naics_2022) ? combined.naics_2022 : [];
      if (!data.length && combined.naics_2022_url) {
        try {
          data = await fetch(combined.naics_2022_url).then(r => r.json());
        } catch(e) {
          console.error('Failed to load 2022 dataset from URL:', e);
          data = [];
        }
      }

      naics2022 = data;
      indexByCode = {};
      for (const row of naics2022) {
        const code = String(row.Code || '').trim();
        if (/^\d{6}$/.test(code)) indexByCode[code] = row;
      }
    }

    async function runSearch() {
      const q    = (document.getElementById('searchInput')?.value || '');
      const code = normalizeCode(q);

      // Exact code path: 6 digits only → 2022 record or legacy banner
      if (/^\d{6}$/.test(code)) {
        const rec = indexByCode[code];
        if (rec) { hideLegacyBanner(); renderResults([rec]); return; }
        showLegacyBanner(code, guidance[code] || {});
        renderResults([]); // keep results blocked for legacy
        return;
      }

      // Keyword search path (2022-only)
      hideLegacyBanner();
      const results = keywordSearch(q, naics2022);
      renderResults(results);
    }

    (async function init(){
      await loadCombined();
      const searchBox = document.getElementById('searchInput');
      if (searchBox) {
        searchBox.addEventListener('input', () => hideLegacyBanner());
        searchBox.addEventListener('keydown', (e) => { if (e.key === 'Enter') runSearch(); });
      }
      document.getElementById('btnSearch')?.addEventListener('click', runSearch);
    })();
  </script>
</body>
